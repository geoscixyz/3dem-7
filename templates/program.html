{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block content %}
  {% include "navbar.html" %}

  <header>
    <h1>{{ page.title }}</h1>
  </header>

  <main class="container">

  <nav class="program-nav navbar navbar-expand-md mb-5">
    <ul class="d-none d-md-flex navbar-nav me-auto mb-2 mb-lg-0">
      {% for day, _ in page.extra.events | group_by(attribute="day") %}
      <li class="nav-item">
        <a class="nav-link active" href="#{{ day | date(format="%Y-%m-%d") }}">
          {{ day | date(format="%A %e") }}
        </a>
      </li>
      {% endfor %}
    </ul>
    <div class="gx-5">
      <a class="btn btn-primary" href="/{{ page.extra.proceedings }}" role="button">
        Download all proceedings
      </a>
      <a class="btn btn-primary" href="/{{ page.extra.pdf }}" role="button">
        Download program
      </a>
    </div>
  </nav>

  <div class="row gy-5">
  {% for day, events in page.extra.events | group_by(attribute="day") %}
    {% set_global i = 0 %}
    {% set_global previous_end = 0 %}

    <div class="col-lg-6 col-md-12">
      <h2 id={{ day | date(format="%Y-%m-%d") }} class="timeline-day">{{ day | date(format="%A %e") }}</h2>

      <div class="timeline">
        <ul>
        {% for event in events | sort(attribute="from") %}

          {# Transform from and to as timestamps #}
          {% set from = macros::timestamp(day=event.day, hhmm=event.from) %}
          {% set to = macros::timestamp(day=event.day, hhmm=event.to) %}

          {# Check consistency of start and end times #}
          {% set from_unix = from | date(format="%s") | int %}
          {% if previous_end > from_unix %}
            {{ throw(message="Inconsistent start time for " ~ "'" ~ event.title ~ "'" ) }}
          {% endif %}
          {% set_global previous_end = to | date(format="%s") | int %}


          <li>
            <span class="timeline-date">
              {{ from | date(format="%l:%M %P") }} -
              {{ to | date(format="%l:%M %P") }}
            </span>
            <div class="timeline-content">
              <h3>{{ event.title }}</h3>
              {# Add session's chair #}
              {% if event.chair %}
              <p>
                <em>
                  Chair: {{ event.chair | markdown(inline=true) | safe }}
                </em>
              </p>
              {% endif %}
              {# Add content #}
              {% if event.content %}
                {{ event.content | markdown | safe }}
              {% endif %}
              {# List talks happening in this event #}
              {% if event.talks %}
                <ul class="talks">
                {% for talk in event.talks %}
                  <li>
                    <h4>{{ talk.title }}</h4>
                    <p>{{ talk.authors }}</p>
                    {% if talk.abstract %}
                    <a href="/abstracts/{{ talk.abstract }}" class="btn btn-outline-light">Read abstract</a>
                    {% endif %}
                    {% if talk.slides %}
                    <a href="/presentations/{{ talk.slides }}" class="btn btn-outline-light">Download slides</a>
                    {% endif %}
                  </li>
                {% endfor %}
                </ul>
              {% endif %}
              {# List posters happening in this event #}
              {% if event.posters %}
                <details>
                  <summary>Discover posters</summary>
                  <ul class="talks">
                  {% for poster in event.posters %}
                    <li>
                      <h4>{{ poster.title }}</h4>
                      <p>{{ poster.authors }}</p>
                      {% if poster.abstract %}
                      <a href="/abstracts/{{ poster.abstract }}" class="btn btn-outline-light">Read abstract</a>
                      {% endif %}
                    </li>
                  {% endfor %}
                  </ul>
                </details>
              {% endif %}
            </div>
          </li>

        {% endfor %}
        </ul>
      </div>

    </div>

  {% endfor %}

  </div>

  </main>

  {% include "footer.html" %}
{% endblock %}

